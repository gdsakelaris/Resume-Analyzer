<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Callback - Starscreen</title>
    <link rel="icon" type="image/png" href="/images/Logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 flex items-center justify-center min-h-screen">
    <div class="max-w-md w-full mx-auto p-6">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <h2 class="text-xl font-semibold text-slate-900 mb-2">Connecting LinkedIn...</h2>
            <p class="text-sm text-slate-600" id="status-message">Please wait while we complete the authentication.</p>

            <div id="error-message" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg hidden">
                <p class="text-sm text-red-800"></p>
                <a href="/static/settings.html" class="mt-3 inline-block px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Back to Settings
                </a>
            </div>
        </div>
    </div>

    <script>
        (async function() {
            // Get code and state from URL
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');

            // Check if user denied access
            if (error) {
                showError(`LinkedIn authorization failed: ${errorDescription || error}`);
                return;
            }

            if (!code || !state) {
                showError('Missing authorization code or state parameter. Please try again.');
                return;
            }

            // Get auth token from localStorage
            const token = localStorage.getItem('starscreen_access_token');
            if (!token) {
                showError('You must be logged in to connect LinkedIn. Redirecting to login...');
                setTimeout(() => {
                    window.location.href = '/static/login.html';
                }, 2000);
                return;
            }

            try {
                // Call the callback endpoint with the code and state
                const response = await fetch(`/api/v1/linkedin/auth/callback?code=${encodeURIComponent(code)}&state=${encodeURIComponent(state)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('status-message').textContent = data.message || 'Success! Redirecting...';

                    // Redirect to settings page after success
                    setTimeout(() => {
                        window.location.href = '/static/settings.html?linkedin=connected';
                    }, 1500);
                } else {
                    const errorData = await response.json();
                    showError(errorData.detail || 'Failed to connect LinkedIn account. Please try again.');
                }
            } catch (err) {
                console.error('LinkedIn callback error:', err);
                showError('Network error. Please check your connection and try again.');
            }
        })();

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.querySelector('p').textContent = message;
            errorDiv.classList.remove('hidden');

            // Hide the spinner
            document.querySelector('.animate-spin').classList.add('hidden');
            document.getElementById('status-message').classList.add('hidden');
        }
    </script>
</body>
</html>
